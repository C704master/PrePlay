# PrePlay - 预演伙伴 | 技术实现说明

---

## 技术选型说明

### 核心技术栈

| 技术组件 | 选型 | 说明 |
|---------|-----|------|
| **前端框架** | Streamlit | 快速开发交互式Web应用，魔搭社区创空间原生支持 |
| **后端语言** | Python 3.9+ | AI生态丰富，易于集成多模型API |
| **数据存储** | SQLite | 轻量级、本地持久化，适合创空间无状态部署 |
| **实时通信** | WebSocket | 与讯飞星火API进行流式对话 |
| **AI模型** | 讯飞星火×2、月之暗面Kimi | 多模型协同，红/蓝双角色 + 报告生成 |
| **知识库** | 讯飞知识库API | RAG检索增强，基于用户材料生成训练问题 |
| **部署平台** | 魔搭社区创空间 | ModelScope生态，一键部署，免费GPU资源 |

### 选型理由

**Streamlit**
- 魔搭社区创空间原生支持的SDK，配置即部署
- 快速构建交互式界面，无需前端开发经验
- 内置文件上传、对话、状态管理等组件

**SQLite**
- 魔搭创空间环境限制：无持久化存储，SQLite作为本地数据库
- 轻量级、零配置，适合单机应用
- 满足训练记录、对话消息的持久化需求

**多模型协同**
- 讯飞星火：角色扮演对话（红/蓝双Agent）
- 月之暗面Kimi：长文本分析（训练报告生成）
- 讯飞知识库：RAG检索（基于用户材料生成问题）

---

## 魔搭社区创空间部署

### 项目规范遵循

PrePlay 严格遵循魔搭社区创空间的项目规范，README.md头部配置如下：

```yaml
---
sdk: streamlit
app_file: app.py
domain: nlp
tags:
- 训练
- 对话
- 知识库
license: Apache License 2.0
---
```

### Streamlit配置

`.streamlit/config.toml` 配置文件：

```toml
[server]
headless = true
address = "0.0.0.0"
port = 8501
```

**配置说明**：
- `headless = true`：无头模式，适合创空间部署
- `address = "0.0.0.0"`：监听所有网络接口
- `port = 8501`：Streamlit默认端口

### 部署流程

```
1. 项目代码推送到Git仓库（GitHub/GitLab）
    ↓
2. 在魔搭社区创空间创建新空间
    ↓
3. 关联Git仓库，选择"streamlit"SDK
    ↓
4. 系统自动安装依赖（requirements.txt）
    ↓
5. 自动启动Streamlit应用，生成访问链接
    ↓
6. 用户访问创空间链接，开始使用
```

### 依赖管理

`requirements.txt` 包含所有项目依赖：

```
# 核心依赖
streamlit>=1.50.0
python-dotenv>=1.2.1
websocket-client>=1.9.0
xfyunsdkcore>=0.0.3
xfyunsdksdk>=0.0.3

# AI服务
anthropic>=0.34.0
openai>=2.25.0

# 文件处理
python-docx>=1.2.0
PyPDF2>=3.0.1

# 数据库
SQLAlchemy>=2.0.45

# 其他依赖...
```

### 环境变量配置

在创空间设置中配置环境变量（`.env` 文件内容）：

```bash
# === 讯飞星火（红方） ===
XUNFEI_RED_WS_URL=wss://spark-openapi.cn-huabei-1.xf-yun.com/v1/assistants/{id}
XUNFEI_RED_APP_ID=your_app_id
XUNFEI_RED_API_SECRET=your_api_secret
XUNFEI_RED_API_KEY=your_api_key

# === 讯飞星火（蓝方） ===
XUNFEI_BLUE_WS_URL=wss://spark-openapi.cn-huabei-1.xf-yun.com/v1/assistants/{id}
XUNFEI_BLUE_APP_ID=your_app_id
XUNFEI_BLUE_API_SECRET=your_api_secret
XUNFEI_BLUE_API_KEY=your_api_key

# === 月之暗面（报告生成） ===
MOONSHOT_API_KEY=your_api_key
MOONSHOT_API_URL=https://api.moonshot.cn/v1
MOONSHOT_MODEL=kimi-k2-turbo-preview

# === 讯飞星火知识库 ===
CHATDOC_APP_ID=your_app_id
CHATDOC_API_SECRET=your_api_secret
```

---

## 整体架构设计

### 系统分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                    系统分层架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  表现层：Streamlit Web界面（魔搭创空间）                      │
│  ├── 首页（app.py）：文件上传、训练记录                      │
│  ├── 训练页面（pages/1_训练.py）：红/蓝对话交互               │
│  └── 报告页面（pages/2_报告.py）：训练报告展示               │
│                                                             │
│  业务层：核心业务逻辑                                         │
│  ├── 对话管理：上下文管理、消息持久化                        │
│  ├── 文件处理：文件解析、知识库上传                          │
│  ├── 会话管理：训练会话创建、查询、删除                      │
│  └── 报告生成：对话数据分析、结构化报告生成                  │
│                                                             │
│  服务层：AI服务集成（魔搭生态外调用）                          │
│  ├── 红方服务（services/red_assistant.py）：                  │
│  │   └─ 讯飞星火WebSocket通信（temperature=0.8）            │
│  ├── 蓝方服务（services/blue_assistant.py）：                │
│  │   └─ 讯飞星火WebSocket通信（temperature=0.7）            │
│  ├── 知识库服务（services/knowledge_service.py）：           │
│  │   └─ 讯飞知识库API调用（RAG检索）                       │
│  ├── 报告服务（services/report_service.py）：                │
│  │   └─ 月之暗面Kimi API调用（长文本分析）                  │
│  └── 会话服务（services/session_service.py）：               │
│      └─ SQLite会话管理                                     │
│                                                             │
│  工具层：通用工具模块                                        │
│  ├── 对话管理器（utils/chat_manager.py）：                    │
│  │   └─ 红/蓝方上下文差异化管理                             │
│  └── 文件处理器（utils/file_handler.py）：                   │
│      └─ txt/docx文件解析                                   │
│                                                             │
│  数据层：数据存储                                            │
│  └── SQLite（database.py）：训练记录、对话消息CRUD          │
│                                                             │
│  外部服务：第三方AI服务                                      │
│  ├── 讯飞星火API：角色扮演对话                              │
│  ├── 月之暗面API：长文本分析                                │
│  └── 讯飞知识库API：文档检索                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 数据流向架构

```
┌─────────────────────────────────────────────────────────────┐
│                    数据流向图                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  用户上传文件 → Streamlit接收 → 文件校验 → 知识库API上传      │
│      ↓                                                      │
│  获取知识库ID → 存储到session_state → 刷新页面显示            │
│                                                             │
│  用户开始训练 → 创建训练会话 → 存储会话ID                     │
│      ↓                                                      │
│  用户向红方提问 → 知识库检索 → Prompt构建 → 红方回复          │
│      ↓                                                      │
│  消息存储 → 界面显示                                        │
│                                                             │
│  用户向蓝方求助 → 知识库检索 → Prompt构建 → 蓝方回复          │
│      ↓                                                      │
│  消息存储 → 界面显示                                        │
│                                                             │
│  用户结束训练 → 获取所有消息 → Kimi分析 → 生成报告            │
│      ↓                                                      │
│  存储报告 → 跳转报告页面                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 关键技术实现

### 1. WebSocket实时通信

**技术原理**：与讯飞星火API建立WebSocket长连接，实现流式对话输出

**实现流程**：
```
1. 鉴权：生成HMAC-SHA256签名
2. 连接：建立WebSocket连接
3. 发送：发送用户消息和对话历史
4. 接收：接收流式返回的数据片段
5. 拼接：将数据片段拼接成完整回复
6. 结束：检测结束标志，关闭连接
```

**关键代码逻辑**：
```python
class RedAssistant:
    def _on_open(self, ws):
        # 连接建立后，在新线程中发送消息
        thread.start_new_thread(self._run, (ws,))

    def _on_message(self, ws, message):
        # 接收流式数据，拼接完整回复
        data = json.loads(message)
        content = data["payload"]["choices"]["text"][0]["content"]
        self.answer += content

        if data["payload"]["choices"]["status"] == 2:
            # 检测到结束标志，关闭连接
            ws.close()
```

**鲁棒性设计**：
- 心跳保活：防止连接超时
- 断线重连：网络中断后自动重试
- 超时控制：设置最大等待时间

### 2. RAG检索增强

**技术原理**：通过知识库API检索相关文档片段，将检索结果注入Prompt

**实现流程**：
```
用户问题 → 知识库API检索 → 语义匹配 → 返回检索结果
    ↓
Prompt构建：[知识库参考]\n{检索结果}\n\n[用户问题]\n{用户问题}
    ↓
AI基于检索结果生成针对性的问题/建议
```

**关键实现**：
```python
# 知识库检索
kb_answer = search_document(
    knowledge_file_ids,
    user_input,
    wiki_filter_score=0.83,  # 匹配阈值
    temperature=0.8
)

# 注入Prompt
enhanced_input = f"[知识库参考]\n{kb_answer}\n\n[用户问题]\n{user_input}"
```

**降级机制**：
```
知识库检索
    ↓
成功？ → 是 → 使用检索结果
    ↓
    否 → 降级为常规对话，不使用知识库结果
```

### 3. 多Agent协同

**差异化设计**：

| Agent | 模型 | Temperature | Prompt风格 | 上下文范围 |
|-------|------|-------------|-----------|-----------|
| 红方 | 讯飞星火 | 0.8 | 严厉导师 | 仅用户与红方的交互 |
| 蓝方 | 讯飞星火 | 0.7 | 温暖教练 | 完整对话历史 |

**上下文管理策略**：

```python
# 红方上下文：仅包含用户与红方的交互
def get_red_context():
    return [
        msg for msg in st.session_state.chat_history
        if msg["role"] in ["user", "red"]
    ]

# 蓝方上下文：包含完整对话历史
def get_blue_context():
    return st.session_state.chat_history  # 所有消息
```

**单例模式**：
```python
# 全局共享一个红方实例
_red_assistant = None

def get_red_assistant():
    global _red_assistant
    if _red_assistant is None:
        _red_assistant = RedAssistant()
    return _red_assistant
```

### 4. Streamlit页面路由

**多页面架构**：

```
app.py                    # 首页
├── pages/1_训练.py        # 训练页面
└── pages/2_报告.py        # 报告页面
```

**页面跳转**：
```python
# 首页跳转到训练页面
if st.button("🎯 开始训练"):
    st.switch_page("pages/1_训练.py")

# 训练页面跳转到报告页面
if st.button("📊 查看报告"):
    st.switch_page("pages/2_报告.py")
```

**状态管理**：
```python
# 初始化 session state
if "chat_history" not in st.session_state:
    st.session_state.chat_history = []
if "current_round" not in st.session_state:
    st.session_state.current_round = 0
```

---

## 系统鲁棒性设计

### 1. 降级机制

**知识库检索失败**：
```
知识库检索
    ↓
失败？ → 是 → 降级为常规对话
    ↓
    否 → 使用检索结果
```

**实现代码**：
```python
try:
    kb_answer = search_document(file_ids, user_input)
    enhanced_input = f"[知识库参考]\n{kb_answer}\n\n[用户问题]\n{user_input}"
except Exception as e:
    st.warning(f"知识库检索失败，使用常规对话：{str(e)}")
    enhanced_input = user_input  # 降级
```

### 2. 错误隔离

**单个Agent失败不影响其他Agent**：
```
红方Agent失败 → 用户仍可向蓝方求助
蓝方Agent失败 → 用户仍可向红方提问
知识库Agent失败 → 降级为常规对话
报告Agent失败 → 对话记录仍可查看，只是没有报告
```

### 3. 状态持久化

**SQLite本地存储**：
```python
# 保存训练会话
def create_training_session():
    """创建新的训练会话"""
    # ... 实现细节 ...

# 保存对话消息
def save_training_message(session_id, role, content, source, timestamp):
    """保存对话消息"""
    # ... 实现细节 ...

# 获取历史消息
def get_training_messages(session_id):
    """获取历史消息"""
    # ... 实现细节 ...
```

**持久化价值**：
- 网络断开后仍可查看历史记录
- 页面刷新后对话不丢失
- 支持随时继续训练

---

## 魔搭社区生态集成

### 工具调用能力

PrePlay 充分利用了魔搭社区的模型与工具生态：

| 服务类型 | 用途 | API来源 |
|---------|------|---------|
| 角色扮演对话 | 红/蓝双Agent对话 | 讯飞星火 |
| RAG检索 | 基于用户材料生成问题 | 讯飞知识库 |
| 长文本分析 | 训练报告生成 | 月之暗面Kimi |

### 创空间优势

**一键部署**：
- 无需服务器运维
- 自动依赖安装
- 自动扩缩容

**免费资源**：
- 免费GPU资源（可选）
- 免费存储空间
- 免费网络带宽

**生态集成**：
- 与ModelScope模型库无缝集成
- 支持自定义模型（未来可扩展）
- 社区分享与发现

---

## 总结

### 技术实现亮点

| 技术维度 | 具体实现 |
|---------|---------|
| **架构设计** | 四层架构（表现层、业务层、服务层、数据层） |
| **多Agent协同** | 红蓝双Agent差异化设计，温度参数调节 |
| **RAG检索** | 知识库检索结果注入Prompt，确保问题相关性 |
| **WebSocket通信** | 流式输出，实时对话体验 |
| **系统鲁棒性** | 降级机制、错误隔离、状态持久化 |
| **创空间部署** | 遵循魔搭社区规范，一键部署 |

### 技术创新性

PrePlay 的技术创新不在于使用了多少前沿技术，而在于：

1. **任务拆解**：将"预演式脱敏疗法"拆解为提问、共情、分析、报告四个子任务
2. **Agent协同**：红蓝双Agent形成"压力-支持"的双向调节机制
3. **RAG融合**：知识库检索与Prompt构建的深度融合
4. **鲁棒设计**：降级机制确保系统在复杂任务链中稳定表现

### 为什么适合魔搭社区

- **原生支持**：Streamlit是魔搭社区原生支持的SDK
- **AI生态**：充分利用魔搭社区的模型与工具生态
- **快速迭代**：一键部署，快速验证想法
- **社区分享**：符合"分享即创新"的开源精神

---

**"技术为服务，架构为价值"**
